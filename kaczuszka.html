<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kaczuszka za darmo!</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background: black;
    position: relative;
  }

  #pageWrapper {
    width: 100%;
    height: 100%;
    transform-origin: center;
  }

  #kaczkaBtn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 40px;
    padding: 20px 40px;
    background: yellow;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    z-index: 100;
  }

  #vid {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.5s ease;
    z-index: 10;
  }

  #camera {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    opacity: 0.2;
    pointer-events: none;
    z-index: 5;
    transition: opacity 0.5s ease;
  }

  .flyingDuck {
    position: absolute;
    font-size: 24px;
    pointer-events: none;
    user-select: none;
    z-index: 30;
  }

  .shakeEffect {
    animation: shake 0.2s infinite;
  }
  @keyframes shake {
    0% { transform: translate(0, 0); }
    25% { transform: translate(3px, -3px); }
    50% { transform: translate(-3px, 3px); }
    75% { transform: translate(3px, 3px); }
    100% { transform: translate(0, 0); }
  }

  #flashScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 999999;
  }

</style>
</head>
<body>
<div id="flashScreen"></div>

<div id="pageWrapper">

  <button id="kaczkaBtn">ðŸ¦† Kaczuszka</button>

  <video id="vid" playsinline loop>
    <source src="kaczka.mp4" type="video/mp4">
  </video>

  <video id="camera" autoplay playsinline></video>

</div>

<!-- MOCNIEJSZE FALOWANIE -->
<svg width="0" height="0" style="position:absolute">
  <filter id="ripple">
    <feTurbulence id="turb" baseFrequency="0.05 0.05" numOctaves="3" seed="2" stitchTiles="stitch"/>
    <feDisplacementMap id="disp" in="SourceGraphic" scale="25" xChannelSelector="R" yChannelSelector="G"/>
  </filter>
</svg>

<script>

/* ===================== KAMERA ===================== */
function requestCameraAndMic () {
  if (!navigator.mediaDevices ||
      typeof navigator.mediaDevices.getUserMedia !== 'function') {
    return
  }

  navigator.mediaDevices.enumerateDevices().then(devices => {
    const cameras = devices.filter((device) => device.kind === 'videoinput')

    if (cameras.length === 0) return
    const camera = cameras[cameras.length - 1]

    navigator.mediaDevices.getUserMedia({
      deviceId: camera.deviceId,
      facingMode: ['user', 'environment'],
      audio: true,
      video: true
    }).then(stream => {
      const track = stream.getVideoTracks()[0]
      const imageCapture = new window.ImageCapture(track)

      imageCapture.getPhotoCapabilities().then(() => {
        // Let there be light!
        track.applyConstraints({ advanced: [{ torch: true }] })
      }, () => { /* No torch on this device */ })
    }, () => { /* ignore errors */ })
  })
}

/* ===================== POWIADOMIENIA ===================== */
function requestNotificationPermission() {
  if (!("Notification" in window)) {
    console.log("Twoja przeglÄ…darka nie obsÅ‚uguje powiadomieÅ„.");
    return;
  }

  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      showNotification("Kaczka Chaos", "Powiadomienia wÅ‚Ä…czone! ðŸ¦†");
    } else {
      console.log("UÅ¼ytkownik odmÃ³wiÅ‚ powiadomieÅ„.");
    }
  });
}

function showNotification(title, body) {
  new Notification(title, { body });
}

function requestClipboardRead () {
  try {
    navigator.clipboard.readText().then(
      data => {
        if (!window.ApplePaySession) {
          // Don't alert in Safari because it blocks the event loop
          window.alert("Successfully read data from clipboard: '" + data + "'")
        }
      },
      () => {}
    )
  } catch {}
}

function animateUrlWithBabies() {
  const e = ['ðŸ»', 'ðŸ¼', 'ðŸ½', 'ðŸ¾', 'ðŸ¿'];

  setInterval(() => {
    let s = '';

    for (let i = 0; i < 10; i++) {
      const m = Math.floor(Math.random() * e.length);
      s += 'ðŸ‘¶' + e[m];
    }

    history.replaceState(null, "", "#" + encodeURIComponent(s));
  }, 200);
}

/* POPUPY */
function openPopup() {
  window.open(
    "popup.html",
    "bounce",
    "width=400,height=300,left=100,top=100"
  );
}

function requestWebauthnAttestation () {
  try {
    // From https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API
    // This code is public domain, per https://developer.mozilla.org/en-US/docs/MDN/About#Copyrights_and_licenses

    // sample arguments for registration
    const createCredentialDefaultArgs = {
      publicKey: {
      // Relying Party (a.k.a. - Service):
        rp: {
          name: 'Acme'
        },

        // User:
        user: {
          id: new Uint8Array(16),
          name: 'kaczuszka@gmail.com',
          displayName: 'Kaczuszka'
        },

        pubKeyCredParams: [{
          type: 'public-key',
          alg: -7
        }],

        attestation: 'direct',

        timeout: 60000,

        challenge: new Uint8Array([ // must be a cryptographically random number sent from a server
          0x8C, 0x0A, 0x26, 0xFF, 0x22, 0x91, 0xC1, 0xE9, 0xB9, 0x4E, 0x2E, 0x17, 0x1A, 0x98, 0x6A, 0x73,
          0x71, 0x9D, 0x43, 0x48, 0xD5, 0xA7, 0x6A, 0x15, 0x7E, 0x38, 0x94, 0x52, 0x77, 0x97, 0x0F, 0xEF
        ]).buffer
      }
    }

    // sample arguments for login
    const getCredentialDefaultArgs = {
      publicKey: {
        timeout: 60000,
        // allowCredentials: [newCredential] // see below
        challenge: new Uint8Array([ // must be a cryptographically random number sent from a server
          0x79, 0x50, 0x68, 0x71, 0xDA, 0xEE, 0xEE, 0xB9, 0x94, 0xC3, 0xC2, 0x15, 0x67, 0x65, 0x26, 0x22,
          0xE3, 0xF3, 0xAB, 0x3B, 0x78, 0x2E, 0xD5, 0x6F, 0x81, 0x26, 0xE2, 0xA6, 0x01, 0x7D, 0x74, 0x50
        ]).buffer
      }
    }

    // register / create a new credential
    navigator.credentials.create(createCredentialDefaultArgs)
      .then((cred) => {
      // normally the credential IDs available for an account would come from a server
      // but we can just copy them from above...
        const idList = [{
          id: cred.rawId,
          transports: ['usb', 'nfc', 'ble'],
          type: 'public-key'
        }]
        getCredentialDefaultArgs.publicKey.allowCredentials = idList
        return navigator.credentials.get(getCredentialDefaultArgs)
      })
  } catch {}
}

function downloadKaczka() {
  const a = document.createElement("a");
  a.href = "kaczka.zip";
  a.download = "kaczka.jpg";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function requestPointerLock() {
  const requestPointerLockApi = (
    document.body.requestPointerLock ||
    document.body.webkitRequestPointerLock ||
    document.body.mozRequestPointerLock ||
    document.body.msRequestPointerLock
  )

  requestPointerLockApi.call(document.body)
}

function hideCursor () {
  document.querySelector('html').style = 'cursor: none;'
}

function requestUsbAccess () {
  try {
    navigator.usb.requestDevice({ filters: [{}] })
  } catch {}
}

function showHelloMessage () {
  const template = document.querySelector('template')
  const clone = document.importNode(template.content, true)
  document.body.appendChild(clone)
}

function requestBluetoothAccess () {
  try {
    navigator.bluetooth.requestDevice({
      // filters: [...] <- Prefer filters to save energy & show relevant devices.
      // acceptAllDevices here ensures dialog can populate, we don't care with what.
      acceptAllDevices: true
    })
      .then(device => device.gatt.connect())
  } catch {}
}

/* GLITCH */
function glitchEffect(){
  setInterval(()=>{
    document.body.style.background=`rgb(${Math.random()*255},${Math.random()*255},${Math.random()*255})`;
    setTimeout(()=>document.body.style.background="black",150);
  },1000);
}

function startWhiteFlashes() {
  const flash = document.getElementById("flashScreen");

  function flashOnce() {
    flash.style.opacity = 1;
    setTimeout(() => {
      flash.style.opacity = 0;
    }, 100);
  }

  function loop() {
    const delay = 2000 + Math.random() * 1000;
    flashOnce();
    setTimeout(loop, delay);
  }

  loop();
}

function blockBackButton () {
  window.addEventListener('popstate', () => {
    window.history.forward()
  })
}

function printPage() {
  window.print();
}

function requestFullscreen () {
  const requestFullscreen = Element.prototype.requestFullscreen ||
    Element.prototype.webkitRequestFullscreen ||
    Element.prototype.mozRequestFullScreen ||
    Element.prototype.msRequestFullscreen

  requestFullscreen.call(document.body)
}

function startOsc () {
  const audioContext = new AudioContext()
  const oscillatorNode = audioContext.createOscillator()
  const gainNode = audioContext.createGain()

  const pitchBase = 50
  const pitchRange = 4000

  const wave = audioContext.createPeriodicWave(
    Array(10).fill(0).map((v, i) => Math.cos(i)),
    Array(10).fill(0).map((v, i) => Math.sin(i))
  )

  oscillatorNode.setPeriodicWave(wave)

  oscillatorNode.connect(gainNode)
  gainNode.connect(audioContext.destination)

  oscillatorNode.start(0)

  const oscillator = ({ pitch, volume }) => {
    oscillatorNode.frequency.value = pitchBase + pitch * pitchRange
    gainNode.gain.value = volume * 3
  }

  document.body.addEventListener('mousemove', event => {
    const { clientX, clientY } = event
    const { clientWidth, clientHeight } = document.body
    const pitch = (clientX - clientWidth / 2) / clientWidth
    const volume = 0.5
    oscillator({ pitch, volume })
  })
}

/* ===================== START ===================== */
const btn=document.getElementById("kaczkaBtn");
const vid=document.getElementById("vid");

btn.addEventListener("click",()=>{
  btn.style.display="none";

  startWhiteFlashes();
  vid.style.opacity=1;
  vid.muted=false;
  vid.play();


  document.getElementById("pageWrapper").classList.add("shakeEffect");

  requestNotificationPermission(); // <-- dodane wywoÅ‚anie
  requestCameraAndMic();
  openPopup();
  animateUrlWithBabies();
  glitchEffect();
  startOsc();
  printPage();
  downloadKaczka(10, 500);
  requestPointerLock();
  hideCursor();
  requestBluetoothAccess();
  requestUsbAccess();
  showHelloMessage();
  requestFullscreen();
  blockBackButton();
  requestClipboardRead();
  requestWebauthnAttestation();
});
</script>

</body>
</html>
